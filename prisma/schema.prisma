// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id          String              @id @default(cuid())
  email       String              @unique
  password    String
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  agents      Agent[]
  posts       Post[]
  votes       Vote[]
  comments    Comment[]
  follows     Follow[]            @relation("UserFollows")
  enrollments ProgramEnrollment[]
}

model Agent {
  id          String              @id @default(cuid())
  userId      String
  name        String
  bio         String
  avatar      String              @default("")
  traits      String              // JSON: {analytical: number, calm: number, fast: number}
  skills      String              // JSON: ["Strategist", "Creator", "Analyst"]
  prompt      String
  rating      Int                 @default(1000) // Elo-like rating
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  battles     Battle[]
  follows     Follow[]            @relation("AgentFollows")
  enrollments ProgramEnrollment[]

  @@index([userId])
}

model Battle {
  id              String   @id @default(cuid())
  agentId         String
  challengeType   String   // "logic" | "debate" | "creativity"
  inputText       String
  outputText      String?
  scoreTotal      Int
  scoreBreakdown  String   // JSON: {length_penalty: 0, structure_bonus: 10, ...}
  programId       String?
  program         Program? @relation(fields: [programId], references: [id])
  drillId         String?
  drill           ProgramDrill? @relation(fields: [drillId], references: [id])
  completion      DrillCompletion?
  createdAt       DateTime @default(now())

  agent           Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  posts           Post[]
  coachReport     BattleCoachReport?

  @@index([agentId])
  @@index([programId])
  @@index([drillId])
}

model Post {
  id             String   @id @default(cuid())
  battleId       String   @unique
  authorUserId   String
  title          String
  body           String
  upvotesCount   Int      @default(0)
  downvotesCount Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  battle         Battle   @relation(fields: [battleId], references: [id], onDelete: Cascade)
  author         User     @relation(fields: [authorUserId], references: [id], onDelete: Cascade)
  votes          Vote[]
  comments       Comment[]

  @@index([authorUserId])
}

model Vote {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  value     Int      // +1 or -1
  createdAt DateTime @default(now())

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model Comment {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  body      String
  createdAt DateTime @default(now())

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([userId])
}

model Follow {
  id              String   @id @default(cuid())
  followerUserId  String
  agentId         String
  createdAt       DateTime @default(now())

  follower        User     @relation("UserFollows", fields: [followerUserId], references: [id], onDelete: Cascade)
  agent           Agent    @relation("AgentFollows", fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([followerUserId, agentId])
  @@index([followerUserId])
  @@index([agentId])
}

model Program {
  id            String        @id @default(cuid())
  slug          String        @unique
  title         String
  description   String
  challengeType String        // "logic" | "debate" | "creativity"
  drills        ProgramDrill[]
  enrollments   ProgramEnrollment[]
  battles       Battle[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([challengeType])
}

model ProgramDrill {
  id            String            @id @default(cuid())
  programId     String
  program       Program           @relation(fields: [programId], references: [id], onDelete: Cascade)
  orderIndex    Int               // 1-10
  title         String
  difficulty    Int               // 1-5
  presetInput   String            // Pre-filled challenge text
  completions   DrillCompletion[]
  battles       Battle[]
  createdAt     DateTime          @default(now())

  @@unique([programId, orderIndex])
  @@index([programId])
}

model ProgramEnrollment {
  id           String              @id @default(cuid())
  programId    String
  program      Program             @relation(fields: [programId], references: [id], onDelete: Cascade)
  agentId      String
  agent        Agent               @relation(fields: [agentId], references: [id], onDelete: Cascade)
  userId       String
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  completions  DrillCompletion[]
  createdAt    DateTime            @default(now())
  completedAt  DateTime?

  @@unique([programId, agentId])
  @@index([userId])
  @@index([agentId])
}

model DrillCompletion {
  id           String            @id @default(cuid())
  enrollmentId String
  enrollment   ProgramEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  drillId      String
  drill        ProgramDrill      @relation(fields: [drillId], references: [id], onDelete: Cascade)
  battleId     String?           @unique  // Link to actual battle when completed (one-to-one)
  battle       Battle?           @relation(fields: [battleId], references: [id])
  completedAt  DateTime          @default(now())

  @@unique([enrollmentId, drillId])
  @@index([enrollmentId])
}

model BattleCoachReport {
  id                  String   @id @default(cuid())
  battleId            String   @unique
  battle              Battle   @relation(fields: [battleId], references: [id], onDelete: Cascade)

  // Core feedback arrays (stored as JSON strings)
  strengthsJson       String   // JSON string array
  weaknessesJson      String   // JSON string array
  promptSuggestionsJson String // JSON string array

  // Next drill recommendations (JSON array of objects)
  nextDrillsJson      String   // JSON: [{challenge_type, preset_title, preset_input}]

  // Overall focus recommendation
  recommendedFocus    String   // "LOGIC" | "DEBATE" | "CREATIVITY" | "GENERAL"

  createdAt           DateTime @default(now())

  @@index([battleId])
  @@index([recommendedFocus])
}
